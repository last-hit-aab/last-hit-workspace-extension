{"version":3,"sources":["../lib/entry-point.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,8CAAwB;AACxB,oDAA8B;AAuB9B,IAAM,aAAa,GAAG;IACrB,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC;AAC1C,CAAC,CAAC;AAEF;IAAA;QAES,aAAQ,GAAa,EAAE,CAAC;IAgKjC,CAAC;IA1JU,0DAAW,GAArB,UAAsB,GAAW,EAAE,IAAiB,EAAE,YAAoB;QACzE,IAAI,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;QACjC,IAAI,CAAC,OAAO,EAAE;YACb,IAAM,UAAU,GAAG,cAAI,CAAC,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE,EAAE,YAAY,CAAC,CAAC;YACtE,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,GAAG,EAAE,UAAU,YAAA,EAAE,IAAI,MAAA,EAAa,CAAC;YACrD,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC;YACzC,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;YAC7B,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE;gBACpB,OAAO,CAAC,MAAM,GAAG,aAAa,CAAC;aAC/B;SACD;QACD,OAAO,OAAO,CAAC;IAChB,CAAC;IACK,uEAAwB,GAA9B,UACC,KAAkD,EAClD,OAA8C;;;;4BAEvC,qBAAM,IAAI,CAAC,WAAW,CAAC,aAAa,EAAE,aAAa,EAAE,aAAa,CAAC,CAAC,MAAO,CACjF,KAAK,EACL,OAAO,CACP,EAAA;4BAHD,sBAAO,SAGN,EAAC;;;;KACF;IAEK,iEAAkB,GAAxB,UACC,KAA4C,EAC5C,OAA8C;;;;4BAEvC,qBAAM,IAAI,CAAC,WAAW,CAC5B,mBAAiB,KAAK,CAAC,KAAK,CAAC,IAAM,EACnC,eAAe,EACZ,KAAK,CAAC,KAAK,CAAC,IAAI,mBAAgB,CACnC,CAAC,MAAO,CAAC,KAAK,EAAE,OAAO,CAAC,EAAA;4BAJzB,sBAAO,SAIkB,EAAC;;;;KAC1B;IAEK,oEAAqB,GAA3B,UACC,KAA+C,EAC/C,OAA8C;;;;4BAEvC,qBAAM,IAAI,CAAC,WAAW,CAC5B,uBAAqB,KAAK,CAAC,IAAI,CAAC,IAAI,SAAI,KAAK,CAAC,KAAK,CAAC,IAAM,EAC1D,mBAAmB,EAChB,KAAK,CAAC,KAAK,CAAC,IAAI,SAAI,KAAK,CAAC,IAAI,CAAC,IAAI,uBAAoB,CAC1D,CAAC,MAAO,CAAC,KAAK,EAAE,OAAO,CAAC,EAAA;4BAJzB,sBAAO,SAIkB,EAAC;;;;KAC1B;IACK,qEAAsB,GAA5B,UACC,KAAgD,EAChD,OAA2C;;;;4BAEpC,qBAAM,IAAI,CAAC,WAAW,CAC5B,uBAAqB,KAAK,CAAC,IAAI,CAAC,IAAI,SAAI,KAAK,CAAC,KAAK,CAAC,IAAM,EAC1D,mBAAmB,EAChB,KAAK,CAAC,KAAK,CAAC,IAAI,SAAI,KAAK,CAAC,IAAI,CAAC,IAAI,uBAAoB,CAC1D,CAAC,MAAO,CAAC,KAAK,EAAE,OAAO,CAAC,EAAA;4BAJzB,sBAAO,SAIkB,EAAC;;;;KAC1B;IAEK,oEAAqB,GAA3B,UACC,KAA+C,EAC/C,OAA2C;;;;4BAEpC,qBAAM,IAAI,CAAC,WAAW,CAC5B,uBAAqB,KAAK,CAAC,IAAI,CAAC,QAAQ,SAAI,KAAK,CAAC,IAAI,CAAC,IAAI,SAAI,KAAK,CAAC,KAAK,CAAC,IAAM,EACjF,mBAAmB,EAChB,KAAK,CAAC,KAAK,CAAC,IAAI,SAAI,KAAK,CAAC,IAAI,CAAC,IAAI,SAAI,KAAK,CAAC,IAAI,CAAC,QAAQ,uBAAoB,CACjF,CAAC,MAAO,CAAC,KAAK,EAAE,OAAO,CAAC,EAAA;4BAJzB,sBAAO,SAIkB,EAAC;;;;KAC1B;IACK,gEAAiB,GAAvB,UACC,KAA2C,EAC3C,OAA2C;;;;4BAEpC,qBAAM,IAAI,CAAC,WAAW,CAC5B,mBAAiB,KAAK,CAAC,IAAI,CAAC,QAAQ,SAAI,KAAK,CAAC,IAAI,CAAC,IAAI,SAAI,KAAK,CAAC,KAAK,CAAC,IAAM,EAC7E,eAAe,EACZ,KAAK,CAAC,KAAK,CAAC,IAAI,SAAI,KAAK,CAAC,IAAI,CAAC,IAAI,SAAI,KAAK,CAAC,IAAI,CAAC,QAAQ,mBAAgB,CAC7E,CAAC,MAAO,CAAC,KAAK,EAAE,OAAO,CAAC,EAAA;4BAJzB,sBAAO,SAIkB,EAAC;;;;KAC1B;IACK,qEAAsB,GAA5B,UACC,KAAgD,EAChD,OAA2C;;;;4BAEpC,qBAAM,IAAI,CAAC,WAAW,CAC5B,uBAAqB,KAAK,CAAC,IAAI,CAAC,QAAQ,SAAI,KAAK,CAAC,IAAI,CAAC,IAAI,SAAI,KAAK,CAAC,KAAK,CAAC,IAAM,EACjF,mBAAmB,EAChB,KAAK,CAAC,KAAK,CAAC,IAAI,SAAI,KAAK,CAAC,IAAI,CAAC,IAAI,SAAI,KAAK,CAAC,IAAI,CAAC,QAAQ,uBAAoB,CACjF,CAAC,MAAO,CAAC,KAAK,EAAE,OAAO,CAAC,EAAA;4BAJzB,sBAAO,SAIkB,EAAC;;;;KAC1B;IAED,sEAAuB,GAAvB,UAAwB,KAAiD;QAAzE,iBAKC;QAJA,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,OAAO,CAAC,UAAA,OAAO;YAC3C,KAAI,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAC/B,CAAC,CAAC,CAAC;QACH,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;IACD,uEAAwB,GAAxB,UAAyB,KAAkD;QAA3E,iBASC;QARA,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC;aAC1B,MAAM,CAAC,UAAA,OAAO;YACd,OAAO,OAAO,CAAC,KAAK,KAAK,KAAK,CAAC,KAAK,CAAC,IAAI,CAAC;QAC3C,CAAC,CAAC;aACD,OAAO,CAAC,UAAA,OAAO;YACf,KAAI,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAC/B,CAAC,CAAC,CAAC;QACJ,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;IACD,sEAAuB,GAAvB,UAAwB,KAAiD;QAAzE,iBASC;QARA,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC;aAC1B,MAAM,CAAC,UAAA,OAAO;YACd,OAAO,OAAO,CAAC,KAAK,KAAK,KAAK,CAAC,KAAK,CAAC,IAAI,IAAI,OAAO,CAAC,IAAI,KAAK,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC;QAC/E,CAAC,CAAC;aACD,OAAO,CAAC,UAAA,OAAO;YACf,KAAI,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAC/B,CAAC,CAAC,CAAC;QACJ,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;IACD,sEAAuB,GAAvB,UAAwB,KAAiD;QAAzE,iBAaC;QAZA,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC;aAC1B,MAAM,CAAC,UAAA,OAAO;YACd,OAAO,CACN,OAAO,CAAC,KAAK,KAAK,KAAK,CAAC,KAAK,CAAC,IAAI;gBAClC,OAAO,CAAC,IAAI,KAAK,KAAK,CAAC,IAAI,CAAC,IAAI;gBAChC,OAAO,CAAC,QAAQ,KAAK,KAAK,CAAC,IAAI,CAAC,QAAQ,CACxC,CAAC;QACH,CAAC,CAAC;aACD,OAAO,CAAC,UAAA,OAAO;YACf,KAAI,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAC/B,CAAC,CAAC,CAAC;QACJ,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;IACS,8DAAe,GAAzB,UAA0B,OAAgB;QACzC,IAAI;YACH,iBAAO,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;YAC5B,IAAM,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;YAC5C,IAAI,OAAO,IAAI,OAAO,CAAC,OAAO,EAAE;gBAC/B,OAAO,CAAC,MAAM,GAAG,OAAO,CAAC,OAAO,CAAC;aACjC;iBAAM;gBACN,OAAO,CAAC,MAAM,GAAG,OAAO,CAAC;aACzB;SACD;QAAC,OAAO,CAAC,EAAE;YACX,OAAO,OAAO,CAAC,MAAM,CAAC;YACtB,IAAI,CAAC,CAAC,KAAK,IAAI,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,oBAAoB,CAAC,EAAE;gBACrD,4BAA4B;aAC5B;iBAAM;gBACN,OAAO,CAAC,KAAK,CAAC,8BAA4B,OAAO,CAAC,UAAU,MAAG,EAAE,CAAC,CAAC,CAAC;aACpE;SACD;IACF,CAAC;IACD,uDAAQ,GAAR;QACC,IAAI,IAAI,CAAC,kBAAkB,EAAE,EAAE;YAC9B,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;SACzB;aAAM;YACN,OAAO,OAAO,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,+BAA+B,CAAC,CAAC,CAAC;SAClE;IACF,CAAC;IACD,sDAAO,GAAP;QACC,OAAO,WAAW,CAAC;IACpB,CAAC;IACF,2CAAC;AAAD,CAlKA,AAkKC,IAAA;AAlKqB,oFAAoC","file":"entry-point.js","sourcesContent":["import { Extensions, WorkspaceExtensions } from 'last-hit-types';\nimport path from 'path';\nimport decache from 'decache';\n\ntype HandlerType =\n\t| 'env-prepare'\n\t| 'story-prepare'\n\t| 'flow-should-start'\n\t| 'flow-accomplished'\n\t| 'step-should-start'\n\t| 'step-on-error'\n\t| 'step-accomplished';\ntype Handler = {\n\tmodulePath: string;\n\ttype: HandlerType;\n\tstory?: string;\n\tflow?: string;\n\tstepUuid?: string;\n\thandle?: (\n\t\tevent: WorkspaceExtensions.WorkspaceEvent,\n\t\thelpers: WorkspaceExtensions.HandlerTestHelper | WorkspaceExtensions.HandlerBrowserHelper\n\t) => Promise<any>;\n};\ntype Handlers = { [key in string]: Handler };\n\nconst IgnoreHandler = (): Promise<any> => {\n\treturn Promise.resolve({ ignore: true });\n};\n\nexport abstract class AbstractWorkspaceExtensionEntryPoint\n\timplements WorkspaceExtensions.IWorkspaceExtensionEntryPoint {\n\tprivate handlers: Handlers = {};\n\t/**\n\t * get handler location, is a folder.\n\t * normally relative to entry point file\n\t */\n\tabstract getHandlerLocation(): string;\n\tprotected findHandler(key: string, type: HandlerType, relativePath: string): Handler {\n\t\tlet handler = this.handlers[key];\n\t\tif (!handler) {\n\t\t\tconst modulePath = path.join(this.getHandlerLocation(), relativePath);\n\t\t\tthis.handlers[key] = { modulePath, type } as Handler;\n\t\t\tthis.doReloadHandler(this.handlers[key]);\n\t\t\thandler = this.handlers[key];\n\t\t\tif (!handler.handle) {\n\t\t\t\thandler.handle = IgnoreHandler;\n\t\t\t}\n\t\t}\n\t\treturn handler;\n\t}\n\tasync handleEnvironmentPrepare(\n\t\tevent: WorkspaceExtensions.EnvironmentPrepareEvent,\n\t\thelpers: WorkspaceExtensions.HandlerTestHelper\n\t): Promise<WorkspaceExtensions.PreparedEnvironment> {\n\t\treturn await this.findHandler('env-prepare', 'env-prepare', 'env-prepare').handle!(\n\t\t\tevent,\n\t\t\thelpers\n\t\t);\n\t}\n\n\tasync handleStoryPrepare(\n\t\tevent: WorkspaceExtensions.StoryPrepareEvent,\n\t\thelpers: WorkspaceExtensions.HandlerTestHelper\n\t): Promise<WorkspaceExtensions.PreparedStory> {\n\t\treturn await this.findHandler(\n\t\t\t`story-prepare@${event.story.name}`,\n\t\t\t'story-prepare',\n\t\t\t`${event.story.name}/story-prepare`\n\t\t).handle!(event, helpers);\n\t}\n\n\tasync handleFlowShouldStart(\n\t\tevent: WorkspaceExtensions.FlowShouldStartEvent,\n\t\thelpers: WorkspaceExtensions.HandlerTestHelper\n\t): Promise<WorkspaceExtensions.PreparedFlow> {\n\t\treturn await this.findHandler(\n\t\t\t`flow-should-start@${event.flow.name}@${event.story.name}`,\n\t\t\t'flow-should-start',\n\t\t\t`${event.story.name}/${event.flow.name}/flow-should-start`\n\t\t).handle!(event, helpers);\n\t}\n\tasync handleFlowAccomplished(\n\t\tevent: WorkspaceExtensions.FlowAccomplishedEvent,\n\t\thelpers: WorkspaceExtensions.HandlerHelpers\n\t): Promise<WorkspaceExtensions.AccomplishedFlow> {\n\t\treturn await this.findHandler(\n\t\t\t`flow-accomplished@${event.flow.name}@${event.story.name}`,\n\t\t\t'flow-accomplished',\n\t\t\t`${event.story.name}/${event.flow.name}/flow-accomplished`\n\t\t).handle!(event, helpers);\n\t}\n\t\n\tasync handleStepShouldStart(\n\t\tevent: WorkspaceExtensions.StepShouldStartEvent,\n\t\thelpers: WorkspaceExtensions.HandlerHelpers\n\t): Promise<WorkspaceExtensions.PreparedStep> {\n\t\treturn await this.findHandler(\n\t\t\t`step-should-start@${event.step.stepUuid}@${event.flow.name}@${event.story.name}`,\n\t\t\t'step-should-start',\n\t\t\t`${event.story.name}/${event.flow.name}/${event.step.stepUuid}/step-should-start`\n\t\t).handle!(event, helpers);\n\t}\n\tasync handleStepOnError(\n\t\tevent: WorkspaceExtensions.StepOnErrorEvent,\n\t\thelpers: WorkspaceExtensions.HandlerHelpers\n\t): Promise<WorkspaceExtensions.FixedStep> {\n\t\treturn await this.findHandler(\n\t\t\t`step-on-error@${event.step.stepUuid}@${event.flow.name}@${event.story.name}`,\n\t\t\t'step-on-error',\n\t\t\t`${event.story.name}/${event.flow.name}/${event.step.stepUuid}/step-on-error`\n\t\t).handle!(event, helpers);\n\t}\n\tasync handleStepAccomplished(\n\t\tevent: WorkspaceExtensions.StepAccomplishedEvent,\n\t\thelpers: WorkspaceExtensions.HandlerHelpers\n\t): Promise<WorkspaceExtensions.AccomplishedStep> {\n\t\treturn await this.findHandler(\n\t\t\t`step-accomplished@${event.step.stepUuid}@${event.flow.name}@${event.story.name}`,\n\t\t\t'step-accomplished',\n\t\t\t`${event.story.name}/${event.flow.name}/${event.step.stepUuid}/step-accomplished`\n\t\t).handle!(event, helpers);\n\t}\n\n\thandleReloadAllHandlers(event: WorkspaceExtensions.ReloadAllHandlersEvent): Promise<void> {\n\t\tObject.values(this.handlers).forEach(handler => {\n\t\t\tthis.doReloadHandler(handler);\n\t\t});\n\t\treturn Promise.resolve();\n\t}\n\thandleReloadStoryHandler(event: WorkspaceExtensions.ReloadStoryHandlerEvent): Promise<void> {\n\t\tObject.values(this.handlers)\n\t\t\t.filter(handler => {\n\t\t\t\treturn handler.story === event.story.name;\n\t\t\t})\n\t\t\t.forEach(handler => {\n\t\t\t\tthis.doReloadHandler(handler);\n\t\t\t});\n\t\treturn Promise.resolve();\n\t}\n\thandleReloadFlowHandler(event: WorkspaceExtensions.ReloadFlowHandlerEvent): Promise<void> {\n\t\tObject.values(this.handlers)\n\t\t\t.filter(handler => {\n\t\t\t\treturn handler.story === event.story.name && handler.flow === event.flow.name;\n\t\t\t})\n\t\t\t.forEach(handler => {\n\t\t\t\tthis.doReloadHandler(handler);\n\t\t\t});\n\t\treturn Promise.resolve();\n\t}\n\thandleReloadStepHandler(event: WorkspaceExtensions.ReloadStepHandlerEvent): Promise<void> {\n\t\tObject.values(this.handlers)\n\t\t\t.filter(handler => {\n\t\t\t\treturn (\n\t\t\t\t\thandler.story === event.story.name &&\n\t\t\t\t\thandler.flow === event.flow.name &&\n\t\t\t\t\thandler.stepUuid === event.step.stepUuid\n\t\t\t\t);\n\t\t\t})\n\t\t\t.forEach(handler => {\n\t\t\t\tthis.doReloadHandler(handler);\n\t\t\t});\n\t\treturn Promise.resolve();\n\t}\n\tprotected doReloadHandler(handler: Handler) {\n\t\ttry {\n\t\t\tdecache(handler.modulePath);\n\t\t\tconst scripts = require(handler.modulePath);\n\t\t\tif (scripts && scripts.default) {\n\t\t\t\thandler.handle = scripts.default;\n\t\t\t} else {\n\t\t\t\thandler.handle = scripts;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tdelete handler.handle;\n\t\t\tif (e.stack && e.stack.indexOf(\"'MODULE_NOT_FOUND'\")) {\n\t\t\t\t// module not found, ignored\n\t\t\t} else {\n\t\t\t\tconsole.error(`failed to reload handler[${handler.modulePath}]`, e);\n\t\t\t}\n\t\t}\n\t}\n\tactivate(): Promise<void> {\n\t\tif (this.getHandlerLocation()) {\n\t\t\treturn Promise.resolve();\n\t\t} else {\n\t\t\treturn Promise.reject(new Error('Handler location not defined.'));\n\t\t}\n\t}\n\tgetType(): Extensions.ExtensionTypes {\n\t\treturn 'workspace';\n\t}\n}\n"]}